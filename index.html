<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>FloodGuard KL 2050 ‚Äî Smart Flood Response System</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700;900&family=Share+Tech+Mono&family=Exo+2:wght@300;400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<style>
  :root{--bg-deep:#020c18;--bg-panel:#040f1e;--bg-card:#071629;--border:#0d3a5c;--accent-cyan:#00e5ff;--accent-blue:#1a7fe8;--accent-orange:#ff6b35;--accent-red:#ff2d55;--accent-yellow:#ffd600;--accent-green:#00e676;--text-primary:#e0f4ff;--text-secondary:#6baed6;--text-dim:#2a5a7a;--glow-cyan:0 0 20px rgba(0,229,255,0.4);--glow-red:0 0 20px rgba(255,45,85,0.5);--glow-green:0 0 20px rgba(0,230,118,0.4);}
  *{margin:0;padding:0;box-sizing:border-box;}
  body{background:var(--bg-deep);color:var(--text-primary);font-family:'Exo 2',sans-serif;min-height:100vh;overflow-x:hidden;}
  body::before{content:'';position:fixed;top:0;left:0;right:0;bottom:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,0.08) 2px,rgba(0,0,0,0.08) 4px);pointer-events:none;z-index:9999;}
  body::after{content:'';position:fixed;top:0;left:0;right:0;bottom:0;background-image:linear-gradient(rgba(0,229,255,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(0,229,255,0.03) 1px,transparent 1px);background-size:50px 50px;pointer-events:none;z-index:0;}
  header{position:relative;z-index:10;padding:0 24px;height:64px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);background:rgba(4,15,30,0.95);backdrop-filter:blur(10px);}
  .header-left{display:flex;align-items:center;gap:12px;}
  .logo{display:flex;align-items:center;gap:12px;}
  .logo-icon{width:36px;height:36px;}
  .logo-icon svg{width:100%;height:100%;}
  .logo-text{font-family:'Orbitron',monospace;font-weight:900;font-size:18px;letter-spacing:2px;color:var(--accent-cyan);text-shadow:var(--glow-cyan);}
  .logo-sub{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text-secondary);letter-spacing:3px;text-transform:uppercase;}
  .header-right{display:flex;align-items:center;gap:20px;}
  .status-pill{display:flex;align-items:center;gap:8px;padding:6px 14px;border:1px solid var(--accent-green);border-radius:20px;font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--accent-green);letter-spacing:1px;}
  .pulse-dot{width:8px;height:8px;border-radius:50%;background:var(--accent-green);box-shadow:var(--glow-green);animation:pulse 1.5s ease-in-out infinite;}
  @keyframes pulse{0%,100%{opacity:1;transform:scale(1);}50%{opacity:0.5;transform:scale(0.8);}}
  .live-clock{font-family:'Share Tech Mono',monospace;font-size:13px;color:var(--text-secondary);letter-spacing:2px;}
  .main-layout{position:relative;z-index:1;display:grid;grid-template-columns:280px 1fr 300px;height:calc(100vh - 64px);overflow:hidden;}
  .sidebar-left{border-right:1px solid var(--border);background:var(--bg-panel);overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:14px;}
  .sidebar-left::-webkit-scrollbar{width:4px;}
  .sidebar-left::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}
  .section-label{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text-dim);letter-spacing:3px;text-transform:uppercase;padding-bottom:8px;border-bottom:1px solid var(--border);margin-bottom:4px;}
  .rain-control{background:var(--bg-card);border:1px solid var(--border);border-radius:8px;padding:16px;}
  .rain-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;}
  .rain-label{font-family:'Orbitron',monospace;font-size:11px;color:var(--text-secondary);letter-spacing:1px;}
  .rain-value{font-family:'Orbitron',monospace;font-size:20px;font-weight:700;color:var(--accent-cyan);text-shadow:var(--glow-cyan);}
  .rain-unit{font-size:11px;color:var(--text-secondary);}
  input[type="range"]{width:100%;-webkit-appearance:none;height:6px;border-radius:3px;background:linear-gradient(to right,var(--accent-cyan) 0%,var(--accent-cyan) 30%,var(--border) 30%);outline:none;cursor:pointer;touch-action:pan-x;-webkit-tap-highlight-color:transparent;}
  input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:22px;height:22px;border-radius:50%;background:var(--accent-cyan);box-shadow:0 0 10px var(--accent-cyan);cursor:pointer;transition:transform 0.2s;}
  input[type="range"]::-webkit-slider-thumb:hover{transform:scale(1.2);}
  .rain-levels{display:flex;justify-content:space-between;margin-top:8px;}
  .rain-level-item{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);text-align:center;}
  .alert-card{border-radius:8px;padding:14px;border:1px solid;transition:all 0.4s ease;}
  .alert-card.normal{border-color:var(--accent-green);background:rgba(0,230,118,0.05);}
  .alert-card.watch{border-color:var(--accent-yellow);background:rgba(255,214,0,0.05);}
  .alert-card.warning{border-color:var(--accent-orange);background:rgba(255,107,53,0.07);}
  .alert-card.danger{border-color:var(--accent-red);background:rgba(255,45,85,0.08);animation:danger-pulse 1s infinite;}
  @keyframes danger-pulse{0%,100%{box-shadow:none;}50%{box-shadow:var(--glow-red);}}
  .alert-title{font-family:'Orbitron',monospace;font-size:13px;font-weight:700;letter-spacing:2px;margin-bottom:6px;}
  .alert-card.normal .alert-title{color:var(--accent-green);}
  .alert-card.watch .alert-title{color:var(--accent-yellow);}
  .alert-card.warning .alert-title{color:var(--accent-orange);}
  .alert-card.danger .alert-title{color:var(--accent-red);}
  .alert-desc{font-size:12px;color:var(--text-secondary);line-height:1.5;}
  .zone-item{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:var(--bg-card);border:1px solid var(--border);border-radius:6px;cursor:pointer;transition:all 0.2s;margin-bottom:6px;-webkit-tap-highlight-color:transparent;min-height:52px;}
  .zone-item:hover{border-color:var(--accent-cyan);background:rgba(0,229,255,0.05);}
  .zone-item.active{border-color:var(--accent-cyan);background:rgba(0,229,255,0.08);box-shadow:0 0 10px rgba(0,229,255,0.15);}
  .zone-name{font-size:12px;font-weight:600;color:var(--text-primary);}
  .zone-area{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text-secondary);margin-top:2px;}
  .zone-badge{padding:3px 8px;border-radius:12px;font-family:'Share Tech Mono',monospace;font-size:10px;font-weight:600;letter-spacing:1px;}
  .badge-safe{background:rgba(0,230,118,0.15);color:var(--accent-green);border:1px solid rgba(0,230,118,0.3);}
  .badge-watch{background:rgba(255,214,0,0.15);color:var(--accent-yellow);border:1px solid rgba(255,214,0,0.3);}
  .badge-flood{background:rgba(255,45,85,0.15);color:var(--accent-red);border:1px solid rgba(255,45,85,0.3);}
  .badge-risk{background:rgba(255,107,53,0.15);color:var(--accent-orange);border:1px solid rgba(255,107,53,0.3);}
  .map-container{position:relative;background:var(--bg-deep);}
  #map{width:100%;height:100%;}
  /* FIX: Leaflet z-index reduced so sidebar appears on top */
  .leaflet-pane{z-index:200 !important;}
  .leaflet-top,.leaflet-bottom{z-index:300 !important;}
  .leaflet-tile-pane{filter:brightness(0.35) saturate(0.4) hue-rotate(185deg) contrast(1.1);}
  .leaflet-control-zoom a{background:rgba(4,15,30,0.9)!important;border-color:var(--border)!important;color:var(--accent-cyan)!important;font-family:'Orbitron',monospace!important;}
  .leaflet-control-attribution{background:rgba(2,12,24,0.7)!important;color:#2a5a7a!important;font-size:9px!important;}
  .map-overlay-top{position:absolute;top:16px;left:50%;transform:translateX(-50%);z-index:400;display:flex;gap:8px;}
  .map-btn{padding:8px 16px;background:rgba(4,15,30,0.9);border:1px solid var(--border);border-radius:4px;color:var(--text-secondary);font-family:'Share Tech Mono',monospace;font-size:11px;letter-spacing:1px;cursor:pointer;transition:all 0.2s;backdrop-filter:blur(10px);-webkit-tap-highlight-color:transparent;}
  .map-btn:hover,.map-btn.active{border-color:var(--accent-cyan);color:var(--accent-cyan);background:rgba(0,229,255,0.08);box-shadow:0 0 10px rgba(0,229,255,0.2);}
  .map-legend{position:absolute;bottom:30px;left:16px;z-index:400;background:rgba(4,15,30,0.92);border:1px solid var(--border);border-radius:8px;padding:12px 16px;backdrop-filter:blur(10px);}
  .legend-title{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text-dim);letter-spacing:2px;margin-bottom:8px;}
  .legend-item{display:flex;align-items:center;gap:8px;margin-bottom:6px;font-size:11px;color:var(--text-secondary);}
  .legend-dot{width:12px;height:12px;border-radius:50%;}
  .sidebar-right{border-left:1px solid var(--border);background:var(--bg-panel);overflow-y:scroll;overflow-x:hidden;padding:16px;display:flex;flex-direction:column;gap:14px;height:calc(100vh - 64px);}
  .sidebar-right::-webkit-scrollbar{width:4px;}
  .sidebar-right::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}
  .stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
  .stat-card{background:var(--bg-card);border:1px solid var(--border);border-radius:8px;padding:12px;text-align:center;transition:all 0.3s;}
  .stat-card:hover{border-color:var(--accent-cyan);box-shadow:0 0 15px rgba(0,229,255,0.1);}
  .stat-value{font-family:'Orbitron',monospace;font-size:22px;font-weight:700;color:var(--accent-cyan);text-shadow:var(--glow-cyan);line-height:1;}
  .stat-label{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);letter-spacing:1px;margin-top:4px;text-transform:uppercase;}
  .stat-card.red .stat-value{color:var(--accent-red);text-shadow:var(--glow-red);}
  .stat-card.orange .stat-value{color:var(--accent-orange);}
  .stat-card.green .stat-value{color:var(--accent-green);text-shadow:var(--glow-green);}
  .bar-chart{background:var(--bg-card);border:1px solid var(--border);border-radius:8px;padding:14px;overflow:hidden;flex-shrink:0;}
  .bar-row{display:flex;align-items:center;gap:8px;margin-bottom:8px;}
  .bar-name{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text-secondary);width:80px;flex-shrink:0;}
  .bar-track{flex:1;height:8px;background:var(--border);border-radius:4px;overflow:hidden;}
  .bar-fill{height:100%;border-radius:4px;transition:width 0.8s cubic-bezier(0.25,0.46,0.45,0.94);}
  .bar-pct{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text-dim);width:30px;text-align:right;}
  .route-card{background:var(--bg-card);border:1px solid var(--border);border-radius:8px;padding:14px;}
  .route-item{display:flex;align-items:flex-start;gap:10px;padding:10px 0;border-bottom:1px solid var(--border);}
  .route-item:last-child{border-bottom:none;}
  .route-num{width:22px;height:22px;border-radius:50%;background:rgba(0,229,255,0.1);border:1px solid var(--accent-cyan);display:flex;align-items:center;justify-content:center;font-family:'Orbitron',monospace;font-size:10px;color:var(--accent-cyan);flex-shrink:0;}
  .route-info{flex:1;}
  .route-name{font-size:12px;font-weight:600;color:var(--text-primary);margin-bottom:3px;}
  .route-detail{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text-secondary);}
  .route-status{font-family:'Share Tech Mono',monospace;font-size:10px;padding:2px 8px;border-radius:10px;}
  .route-open{background:rgba(0,230,118,0.1);color:var(--accent-green);border:1px solid rgba(0,230,118,0.3);}
  .route-caution{background:rgba(255,214,0,0.1);color:var(--accent-yellow);border:1px solid rgba(255,214,0,0.3);}
  .route-closed{background:rgba(255,45,85,0.1);color:var(--accent-red);border:1px solid rgba(255,45,85,0.3);}
  .alerts-feed{background:var(--bg-card);border:1px solid var(--border);border-radius:8px;padding:14px;min-height:180px;max-height:400px;overflow-y:auto;margin-bottom:24px;}
  .alerts-feed::-webkit-scrollbar{width:3px;}
  .alerts-feed::-webkit-scrollbar-thumb{background:var(--border);}
  .alert-item{display:flex;gap:10px;padding:8px 0;border-bottom:1px solid rgba(13,58,92,0.5);animation:slideIn 0.4s ease;}
  @keyframes slideIn{from{opacity:0;transform:translateX(-10px);}to{opacity:1;transform:translateX(0);}}
  .alert-item:first-child{padding-top:0;}
  .alert-item:last-child{border-bottom:none;}
  .alert-dot{width:8px;height:8px;border-radius:50%;margin-top:4px;flex-shrink:0;}
  .alert-content{flex:1;}
  .alert-msg{font-size:11px;color:var(--text-primary);line-height:1.4;margin-bottom:3px;}
  .alert-time{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);}
  .gauge-container{background:var(--bg-card);border:1px solid var(--border);border-radius:8px;padding:14px;}
  .gauge-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
  .gauge-name{font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--text-secondary);}
  .gauge-bar-wrap{position:relative;height:20px;background:var(--border);border-radius:3px;overflow:hidden;flex:1;margin:0 10px;}
  .gauge-bar-fill{height:100%;border-radius:3px;transition:width 0.8s ease,background 0.5s ease;position:relative;}
  .gauge-bar-fill::after{content:'';position:absolute;top:0;right:0;bottom:0;width:3px;background:white;opacity:0.5;animation:shimmer 1s infinite;}
  @keyframes shimmer{0%,100%{opacity:0.3;}50%{opacity:0.7;}}
  .gauge-pct{font-family:'Orbitron',monospace;font-size:12px;font-weight:700;width:38px;text-align:right;}
  .map-btn-rain{border-color:#4fc3f7!important;color:#4fc3f7!important;}
  .map-btn-rain.panel-open{background:rgba(79,195,247,0.15)!important;box-shadow:0 0 12px rgba(79,195,247,0.3)!important;}
  .map-btn-ai{border-color:#ce93d8!important;color:#ce93d8!important;}
  .map-btn-ai.panel-open{background:rgba(206,147,216,0.15)!important;box-shadow:0 0 12px rgba(206,147,216,0.3)!important;}
  /* FIX: side-panel z-index raised */
  .side-panel{position:fixed;top:80px;right:316px;width:300px;height:calc(100vh - 100px);background:rgba(4,15,30,0.97);border:1px solid var(--border);border-radius:10px;z-index:2000;backdrop-filter:blur(16px);box-shadow:0 8px 40px rgba(0,0,0,0.6),0 0 30px rgba(0,229,255,0.05);animation:panelIn 0.25s cubic-bezier(0.34,1.56,0.64,1);display:flex;flex-direction:column;}
  @keyframes panelIn{from{opacity:0;transform:translateY(-12px) scale(0.97);}to{opacity:1;transform:translateY(0) scale(1);}}
  .side-panel-header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px 10px;border-bottom:1px solid var(--border);}
  .side-panel-title{font-family:'Orbitron',monospace;font-size:11px;font-weight:700;color:var(--accent-cyan);letter-spacing:1px;}
  .panel-close{background:none;border:none;color:var(--text-dim);cursor:pointer;font-size:14px;padding:2px 6px;border-radius:4px;transition:color 0.2s;min-width:36px;min-height:36px;display:flex;align-items:center;justify-content:center;}
  .panel-close:hover{color:var(--accent-red);}
  .side-panel-body{padding:14px 16px 16px;overflow-y:auto;overflow-x:hidden;flex:1;min-height:0;}
  .side-panel-body::-webkit-scrollbar{width:4px;}
  .side-panel-body::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}
  .radar-grid{display:grid;grid-template-columns:repeat(8,1fr);grid-template-rows:repeat(6,1fr);gap:2px;height:130px;border-radius:6px;overflow:hidden;margin-bottom:10px;border:1px solid var(--border);}
  .radar-cell{border-radius:1px;transition:background 1.2s ease;}
  .rain-gradient-bar{height:8px;border-radius:4px;background:linear-gradient(to right,#071629,#1565c0,#4fc3f7,#ffd600,#ff6b35,#ff2d55);margin-top:8px;border:1px solid var(--border);}
  .rain-stats-row{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:10px;}
  .rain-stat-item{background:var(--bg-card);border:1px solid var(--border);border-radius:6px;padding:8px 10px;}
  .rain-stat-val{font-family:'Orbitron',monospace;font-size:16px;font-weight:700;color:var(--accent-cyan);}
  .rain-stat-lbl{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);letter-spacing:1px;margin-top:2px;}
  .panel-timestamp{display:flex;justify-content:space-between;align-items:center;margin-top:10px;font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);}
  .live-badge{color:var(--accent-green);font-size:9px;letter-spacing:1px;animation:pulse 1.5s infinite;}
  .ai-model-badge{font-family:'Share Tech Mono',monospace;font-size:9px;color:#ce93d8;letter-spacing:1px;margin-bottom:12px;padding:5px 8px;background:rgba(206,147,216,0.08);border:1px solid rgba(206,147,216,0.2);border-radius:4px;}
  .forecast-tabs{display:flex;gap:4px;margin-bottom:12px;}
  .ftab{flex:1;padding:5px 0;background:var(--bg-card);border:1px solid var(--border);border-radius:4px;color:var(--text-secondary);font-family:'Share Tech Mono',monospace;font-size:10px;cursor:pointer;transition:all 0.2s;-webkit-tap-highlight-color:transparent;}
  .ftab:hover{border-color:#ce93d8;color:#ce93d8;}
  .ftab.active{background:rgba(206,147,216,0.15);border-color:#ce93d8;color:#ce93d8;}
  .forecast-zone-row{display:flex;align-items:center;justify-content:space-between;padding:7px 0;border-bottom:1px solid rgba(13,58,92,0.5);font-size:11px;}
  .forecast-zone-row:last-child{border-bottom:none;}
  .fz-name{font-weight:600;color:var(--text-primary);width:90px;font-size:11px;}
  .fz-bar-wrap{flex:1;height:6px;background:var(--border);border-radius:3px;margin:0 8px;overflow:hidden;}
  .fz-bar{height:100%;border-radius:3px;transition:width 0.6s ease;}
  .fz-risk{font-family:'Share Tech Mono',monospace;font-size:9px;width:48px;text-align:right;}
  .ai-confidence{margin-top:12px;padding-top:10px;border-top:1px solid var(--border);}
  .conf-label{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);letter-spacing:2px;margin-bottom:6px;}
  .conf-bar-wrap{display:flex;align-items:center;gap:8px;height:10px;background:var(--border);border-radius:5px;overflow:hidden;position:relative;}
  .conf-bar-fill{height:100%;border-radius:5px;background:linear-gradient(to right,#ce93d8,#9c27b0);transition:width 0.8s ease;}
  .conf-pct{position:absolute;right:8px;font-family:'Orbitron',monospace;font-size:9px;color:white;font-weight:700;}
  .ai-warning-box{margin-top:10px;padding:8px 10px;border-radius:6px;font-size:11px;line-height:1.5;}
  .ai-warning-box.warn-danger{background:rgba(255,45,85,0.08);border:1px solid rgba(255,45,85,0.3);color:#ff6b8a;}
  .ai-warning-box.warn-caution{background:rgba(255,214,0,0.06);border:1px solid rgba(255,214,0,0.25);color:#ffd600;}
  .ai-warning-box.warn-ok{background:rgba(0,230,118,0.06);border:1px solid rgba(0,230,118,0.25);color:#00e676;}
  .forecast-chart{margin-top:10px;height:60px;max-height:60px;display:flex;align-items:flex-end;gap:3px;overflow:hidden;}
  .fc-bar-wrap{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;height:100%;justify-content:flex-end;}
  .fc-bar{width:100%;border-radius:2px 2px 0 0;transition:height 0.6s ease;min-height:3px;}
  .fc-time{font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--text-dim);white-space:nowrap;}
  .search-wrap{margin-bottom:8px;}
  .search-wrap input{width:100%;background:var(--bg-card);border:1px solid var(--border);border-radius:6px;padding:9px 12px;color:var(--text-primary);font-family:'Exo 2',sans-serif;font-size:16px;outline:none;transition:border-color 0.2s,box-shadow 0.2s;}
  .search-wrap input::placeholder{color:var(--text-dim);}
  .search-wrap input:focus{border-color:var(--accent-cyan);box-shadow:0 0 10px rgba(0,229,255,0.15);}
  .state-filter{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:10px;max-height:80px;overflow-y:auto;}
  .state-btn{padding:4px 10px;background:var(--bg-card);border:1px solid var(--border);border-radius:10px;color:var(--text-dim);font-family:'Share Tech Mono',monospace;font-size:9px;cursor:pointer;transition:all 0.15s;white-space:nowrap;letter-spacing:0.5px;-webkit-tap-highlight-color:transparent;min-height:28px;}
  .state-btn:hover{border-color:var(--accent-cyan);color:var(--accent-cyan);}
  .state-btn.active{background:rgba(0,229,255,0.1);border-color:var(--accent-cyan);color:var(--accent-cyan);}
  .zone-count{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);text-align:right;margin-bottom:6px;letter-spacing:1px;}
  .flood-tooltip-inner{background:rgba(4,15,30,0.95)!important;border:1px solid #0d3a5c!important;border-radius:6px!important;color:#e0f4ff!important;padding:8px 12px!important;box-shadow:0 0 20px rgba(0,229,255,0.15)!important;}
  .flood-tooltip-inner::before{display:none!important;}
  .leaflet-control-zoom{border:1px solid #0d3a5c!important;border-radius:4px!important;overflow:hidden;}

  /* ===========================
     HAMBURGER BUTTON
     =========================== */
  .hamburger-btn{
    display:none;
    width:44px;height:44px;
    flex-direction:column;align-items:center;justify-content:center;
    gap:5px;cursor:pointer;
    background:rgba(0,229,255,.06);
    border:1px solid var(--border);
    border-radius:8px;flex-shrink:0;transition:all .2s;
    -webkit-tap-highlight-color:transparent;
    touch-action:manipulation;
  }
  .hamburger-btn span{display:block;width:18px;height:2px;background:var(--accent-cyan);border-radius:2px;transition:all .3s;}
  .hamburger-btn.open span:nth-child(1){transform:translateY(7px) rotate(45deg);}
  .hamburger-btn.open span:nth-child(2){opacity:0;}
  .hamburger-btn.open span:nth-child(3){transform:translateY(-7px) rotate(-45deg);}

  /* Drawer overlay */
  .drawer-overlay{
    display:none;
    position:fixed;top:0;left:0;right:0;bottom:0;
    background:rgba(2,12,24,.75);
    opacity:0;transition:opacity .3s;pointer-events:none;
  }
  /* FIX: z-index stacking order fixed */
  .drawer-overlay.visible{opacity:1;pointer-events:all;z-index:1500;}

  /* Bottom nav */
  .bottom-nav{
    display:none;position:fixed;bottom:0;left:0;right:0;
    height:60px;background:rgba(4,15,30,.97);border-top:1px solid var(--border);
    align-items:stretch;backdrop-filter:blur(10px);
  }
  /* FIX: bottom nav z-index */
  .bottom-nav{z-index:600;}
  .bnav-btn{
    flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;
    gap:3px;background:none;border:none;border-right:1px solid var(--border);
    cursor:pointer;color:var(--text-dim);font-family:'Share Tech Mono',monospace;
    font-size:8px;letter-spacing:.5px;transition:all .2s;
    touch-action:manipulation;padding:4px 2px;-webkit-tap-highlight-color:transparent;
  }
  .bnav-btn:last-child{border-right:none;}
  .bnav-btn.active{background:rgba(0,229,255,.08);color:var(--accent-cyan);}
  .bnav-btn .bnav-icon{font-size:18px;line-height:1;}

  /* Bottom sheet */
  .stats-sheet{
    display:none;position:fixed;bottom:60px;left:0;right:0;
    background:var(--bg-panel);border-top:1px solid var(--border);
    border-radius:16px 16px 0 0;max-height:75vh;
    transform:translateY(100%);transition:transform .35s cubic-bezier(.34,1.1,.64,1);
    flex-direction:column;box-shadow:0 -8px 40px rgba(0,0,0,.5);overflow:hidden;
  }
  /* FIX: sheet z-index */
  .stats-sheet{z-index:700;}
  .stats-sheet.open{transform:translateY(0);}
  .sheet-handle{flex-shrink:0;display:flex;align-items:center;justify-content:center;padding:10px 0 6px;cursor:pointer;}
  .sheet-handle-bar{width:40px;height:4px;background:var(--border);border-radius:2px;}
  .sheet-header{display:flex;align-items:center;justify-content:space-between;padding:4px 16px 10px;border-bottom:1px solid var(--border);flex-shrink:0;}
  .sheet-title{font-family:'Orbitron',monospace;font-size:11px;color:var(--accent-cyan);letter-spacing:1px;}
  .sheet-close{background:none;border:none;color:var(--text-dim);font-size:16px;cursor:pointer;padding:4px 8px;min-width:44px;min-height:44px;display:flex;align-items:center;justify-content:center;-webkit-tap-highlight-color:transparent;}
  .sheet-tabs{display:flex;gap:4px;padding:8px 16px 0;flex-shrink:0;overflow-x:auto;scrollbar-width:none;}
  .sheet-tabs::-webkit-scrollbar{display:none;}
  .stab{padding:8px 14px;background:var(--bg-card);border:1px solid var(--border);border-radius:6px 6px 0 0;color:var(--text-dim);font-family:'Share Tech Mono',monospace;font-size:10px;cursor:pointer;white-space:nowrap;flex-shrink:0;touch-action:manipulation;transition:all .2s;-webkit-tap-highlight-color:transparent;min-height:36px;}
  .stab.active{background:rgba(0,229,255,.1);border-color:var(--accent-cyan);color:var(--accent-cyan);}
  .sheet-body{overflow-y:auto;overflow-x:hidden;flex:1;padding:14px 16px 20px;display:flex;flex-direction:column;gap:14px;}
  .sheet-body::-webkit-scrollbar{width:4px;}
  .sheet-body::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}

  /* ===== MOBILE < 900px ===== */
  @media(max-width:899px){
    html{height:-webkit-fill-available;}
    body{touch-action:manipulation;}
    header{height:52px!important;padding:0 10px!important;}
    .hamburger-btn{display:flex!important;}
    .live-clock{display:none!important;}
    .logo-text{font-size:13px!important;letter-spacing:1px!important;}
    .logo-sub{display:none!important;}
    .status-pill{font-size:8px!important;padding:4px 8px!important;}

    .main-layout{
      position:fixed!important;
      top:52px!important;left:0!important;right:0!important;
      bottom:60px!important;
      grid-template-columns:1fr!important;
      height:auto!important;overflow:hidden!important;
    }

    /* FIX: Sidebar z-index now ABOVE overlay and leaflet */
    .sidebar-left{
      position:fixed!important;
      top:52px!important;
      left:-100%!important;
      width:min(300px,85vw)!important;
      height:calc(100dvh - 52px - 60px)!important;
      z-index:1600!important;
      transition:left .3s cubic-bezier(.34,1.1,.64,1)!important;
      overflow-y:auto!important;
      -webkit-overflow-scrolling:touch!important;
      padding-bottom:24px!important;
    }
    .sidebar-left.open{
      left:0!important;
      box-shadow:8px 0 40px rgba(0,0,0,.7)!important;
    }

    /* FIX: Drawer overlay z-index between leaflet and sidebar */
    .drawer-overlay{
      display:block!important;
      z-index:1500!important;
      top:52px!important;
    }
    .drawer-overlay.visible{opacity:1;pointer-events:all;}

    .sidebar-right{display:none!important;}
    .map-container{
      grid-column:1/-1!important;
      width:100%!important;
      height:100%!important;
      position:relative!important;
    }

    /* FIX: Leaflet must stay BELOW sidebar on mobile */
    .leaflet-pane{z-index:200!important;}
    .leaflet-top,.leaflet-bottom{z-index:300!important;}
    .leaflet-container{z-index:1!important;}

    .bottom-nav{display:flex!important;z-index:600!important;}
    .stats-sheet{display:flex!important;z-index:700!important;}

    /* FIX: Side panels on mobile */
    .side-panel{
      right:8px!important;left:8px!important;width:auto!important;
      max-width:none!important;
      top:calc(52px + 8px)!important;
      max-height:calc(100dvh - 52px - 60px - 16px)!important;
      z-index:1400!important;
    }

    .map-overlay-top{
      left:8px!important;transform:none!important;right:8px!important;
      overflow-x:auto!important;-webkit-overflow-scrolling:touch!important;
      scrollbar-width:none!important;justify-content:flex-start!important;
      max-width:none!important;padding-bottom:4px!important;
      z-index:400!important;
    }
    .map-overlay-top::-webkit-scrollbar{display:none!important;}
    .map-btn{min-height:40px!important;flex-shrink:0!important;white-space:nowrap!important;font-size:10px!important;}
    .map-legend{padding:6px 10px!important;bottom:8px!important;z-index:400!important;}
    .legend-title{font-size:8px!important;}
    .legend-item{font-size:9px!important;margin-bottom:3px!important;}
    .legend-dot{width:8px!important;height:8px!important;}
    .leaflet-control-zoom a{width:36px!important;height:36px!important;line-height:36px!important;font-size:18px!important;}

    input[type="range"]::-webkit-slider-thumb{width:28px!important;height:28px!important;}
    input[type="range"]{height:8px!important;}

    .zone-item{min-height:52px!important;padding:12px!important;}
    .state-btn{min-height:32px!important;}
    .stat-value{font-size:26px!important;}
  }

  @media(max-width:899px) and (orientation:landscape){
    .main-layout{top:44px!important;bottom:60px!important;}
    .sidebar-left{top:44px!important;height:calc(100dvh - 44px - 60px)!important;}
    .drawer-overlay{top:44px!important;}
    .stats-sheet{max-height:70vh!important;}
    .side-panel{top:calc(44px + 8px)!important;max-height:calc(100dvh - 44px - 60px - 16px)!important;}
  }
</style>
</head>
<body>

<header>
  <div class="header-left">
    <div class="hamburger-btn" id="hamburgerBtn">
      <span></span><span></span><span></span>
    </div>
    <div class="logo">
      <div class="logo-icon">
        <svg viewBox="0 0 36 36" fill="none">
          <polygon points="18,3 33,28 3,28" stroke="#00e5ff" stroke-width="1.5" fill="none" opacity="0.5"/>
          <polygon points="18,8 29,26 7,26" fill="rgba(0,229,255,0.08)" stroke="#00e5ff" stroke-width="1"/>
          <path d="M10 22 Q14 16 18 20 Q22 24 26 18" stroke="#00e5ff" stroke-width="1.5" fill="none"/>
          <circle cx="18" cy="20" r="2" fill="#00e5ff"/>
        </svg>
      </div>
      <div>
        <div class="logo-text">FLOODGUARD</div>
        <div class="logo-sub">MALAYSIA 2050 ¬∑ Smart Flood Response System</div>
      </div>
    </div>
  </div>
  <div class="header-right">
    <div class="status-pill">
      <div class="pulse-dot" id="systemDot"></div>
      <span id="systemStatus">SYSTEM ONLINE</span>
    </div>
    <div class="live-clock" id="clock">--:--:--</div>
  </div>
</header>

<!-- Drawer overlay -->
<div class="drawer-overlay" id="drawerOverlay"></div>

<!-- Bottom Nav (mobile) -->
<nav class="bottom-nav">
  <button class="bnav-btn active" id="bnav-map"><span class="bnav-icon">üó∫Ô∏è</span><span>MAP</span></button>
  <button class="bnav-btn" id="bnav-rain"><span class="bnav-icon">üåßÔ∏è</span><span>RAIN</span></button>
  <button class="bnav-btn" id="bnav-stats"><span class="bnav-icon">üìä</span><span>STATS</span></button>
  <button class="bnav-btn" id="bnav-alerts"><span class="bnav-icon">üîî</span><span>ALERTS</span></button>
  <button class="bnav-btn" id="bnav-routes"><span class="bnav-icon">üõ£Ô∏è</span><span>ROUTES</span></button>
</nav>

<!-- Bottom Sheet (mobile stats) -->
<div class="stats-sheet" id="statsSheet">
  <div class="sheet-handle" id="sheetHandle"><div class="sheet-handle-bar"></div></div>
  <div class="sheet-tabs">
    <button class="stab active" id="stab-stats">üìä STATS</button>
    <button class="stab" id="stab-gauges">üíß GAUGES</button>
    <button class="stab" id="stab-risk">‚ö†Ô∏è RISK</button>
    <button class="stab" id="stab-routes">üõ£Ô∏è ROUTES</button>
    <button class="stab" id="stab-alerts">üîî ALERTS</button>
  </div>
  <div class="sheet-header">
    <span class="sheet-title" id="sheetTitle">LIVE STATISTICS</span>
    <button class="sheet-close" id="sheetCloseBtn">‚úï</button>
  </div>
  <div class="sheet-body" id="sheetBody"></div>
</div>

<div class="main-layout">
  <!-- SIDEBAR LEFT -->
  <div class="sidebar-left" id="sidebarLeft">
    <div class="section-label">Rainfall Simulation</div>
    <div class="rain-control">
      <div class="rain-header">
        <div class="rain-label">RAINFALL INTENSITY</div>
        <div><span class="rain-value" id="rainVal">30</span><span class="rain-unit"> mm/hr</span></div>
      </div>
      <input type="range" id="rainSlider" min="0" max="200" value="30">
      <div class="rain-levels">
        <div class="rain-level-item">CLEAR<br>0</div>
        <div class="rain-level-item">LIGHT<br>25</div>
        <div class="rain-level-item">MOD<br>75</div>
        <div class="rain-level-item">HEAVY<br>125</div>
        <div class="rain-level-item">EXTREME<br>200</div>
      </div>
    </div>
    <div class="alert-card" id="alertCard">
      <div class="alert-title" id="alertTitle">‚óè NORMAL</div>
      <div class="alert-desc" id="alertDesc">Rainfall within safe parameters. All monitoring stations operational.</div>
    </div>
    <div class="section-label">Monitored Zones</div>
    <div class="search-wrap">
      <input type="text" id="searchBar" placeholder="üîç  Cari daerah / negeri..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
    </div>
    <div class="state-filter" id="stateFilter">
      <button class="state-btn active">ALL</button>
    </div>
    <div class="zone-count" id="zoneCountBadge">‚Äî DAERAH</div>
    <div id="zoneList"></div>
  </div>

  <!-- MAP -->
  <div class="map-container">
    <div id="map"></div>
    <div class="map-overlay-top">
      <button class="map-btn active" id="btn-flood">üåä FLOOD ZONES</button>
      <button class="map-btn" id="btn-routes">üõ£Ô∏è EVAC ROUTES</button>
      <button class="map-btn" id="btn-stations">üì° STATIONS</button>
      <button class="map-btn map-btn-rain" id="btn-rain">üåßÔ∏è LIVE RAIN</button>
      <button class="map-btn map-btn-ai" id="btn-ai">ü§ñ AI FORECAST</button>
    </div>
    <div class="map-legend" id="mapLegend">
      <div class="legend-title">FLOOD RISK LEVEL</div>
      <div class="legend-item"><div class="legend-dot" style="background:#ff2d55"></div> Critical / Flooded</div>
      <div class="legend-item"><div class="legend-dot" style="background:#ff6b35"></div> High Risk</div>
      <div class="legend-item"><div class="legend-dot" style="background:#ffd600"></div> Watch Zone</div>
      <div class="legend-item"><div class="legend-dot" style="background:#00e676"></div> Safe Zone</div>
    </div>
  </div>

  <!-- LIVE RAIN PANEL -->
  <div class="side-panel" id="panel-rain" style="display:none">
    <div class="side-panel-header">
      <span class="side-panel-title">üåßÔ∏è LIVE RAINFALL RADAR</span>
      <button class="panel-close" id="closeRainPanel">‚úï</button>
    </div>
    <div class="side-panel-body">
      <div class="radar-grid" id="radarGrid"></div>
      <div class="rain-legend-row">
        <span style="color:var(--text-dim);font-size:9px;font-family:'Share Tech Mono',monospace;letter-spacing:1px">INTENSITY (mm/hr)</span>
        <div class="rain-gradient-bar"></div>
        <div style="display:flex;justify-content:space-between;margin-top:4px">
          <span style="font-size:9px;color:var(--text-dim);font-family:'Share Tech Mono',monospace">0</span>
          <span style="font-size:9px;color:#4fc3f7;font-family:'Share Tech Mono',monospace">25</span>
          <span style="font-size:9px;color:#ffd600;font-family:'Share Tech Mono',monospace">75</span>
          <span style="font-size:9px;color:#ff6b35;font-family:'Share Tech Mono',monospace">125</span>
          <span style="font-size:9px;color:#ff2d55;font-family:'Share Tech Mono',monospace">200+</span>
        </div>
      </div>
      <div class="rain-stats-row" id="rainStatsRow"></div>
      <div class="panel-timestamp">
        <span id="radarTimestamp"></span>
        <span class="live-badge">‚óè LIVE</span>
      </div>
    </div>
  </div>

  <!-- AI FORECAST PANEL -->
  <div class="side-panel" id="panel-ai" style="display:none">
    <div class="side-panel-header">
      <span class="side-panel-title">ü§ñ AI FLOOD FORECAST</span>
      <button class="panel-close" id="closeAiPanel">‚úï</button>
    </div>
    <div class="side-panel-body">
      <div class="ai-model-badge">MODEL: FloodNet-KL v2.4 ¬∑ Updated <span id="aiUpdateTime"></span></div>
      <div class="forecast-tabs">
        <button class="ftab active" data-h="1">+1H</button>
        <button class="ftab" data-h="3">+3H</button>
        <button class="ftab" data-h="6">+6H</button>
        <button class="ftab" data-h="12">+12H</button>
        <button class="ftab" data-h="24">+24H</button>
      </div>
      <div id="forecastContent" style="overflow-y:auto;max-height:220px;margin-bottom:8px;"></div>
      <div class="ai-confidence">
        <div class="conf-label">MODEL CONFIDENCE</div>
        <div class="conf-bar-wrap">
          <div class="conf-bar-fill" id="confBar"></div>
          <span class="conf-pct" id="confPct"></span>
        </div>
      </div>
      <div class="ai-warning-box" id="aiWarningBox" style="margin-top:8px;"></div>
      <div style="margin-top:8px;">
        <div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);letter-spacing:2px;margin-bottom:4px;">HOURLY FORECAST</div>
        <div class="forecast-chart" id="forecastChart"></div>
      </div>
    </div>
  </div>

  <!-- SIDEBAR RIGHT -->
  <div class="sidebar-right">
    <div class="section-label">Live Statistics</div>
    <div class="stats-grid">
      <div class="stat-card red"><div class="stat-value" id="statFlooded">2</div><div class="stat-label">Zones Flooded</div></div>
      <div class="stat-card orange"><div class="stat-value" id="statRisk">3</div><div class="stat-label">At Risk</div></div>
      <div class="stat-card"><div class="stat-value" id="statPop">142K</div><div class="stat-label">Pop. Affected</div></div>
      <div class="stat-card green"><div class="stat-value" id="statRoutes">5</div><div class="stat-label">Routes Open</div></div>
    </div>
    <div class="section-label">Water Level ‚Äî Gauges</div>
    <div class="gauge-container">
      <div class="gauge-row" style="margin-bottom:14px">
        <span style="font-family:'Orbitron',monospace;font-size:10px;color:var(--text-secondary);letter-spacing:1px;">RIVER STATIONS</span>
      </div>
      <div id="gaugeList"></div>
    </div>
    <div class="section-label">Flood Risk by Area</div>
    <div class="bar-chart"><div id="barChartContent"></div></div>
    <div class="section-label" id="routeSection">Evacuation Routes (KL)</div>
    <div class="route-card" id="routeList"></div>
    <div class="section-label">Alert Feed</div>
    <div class="alerts-feed" id="alertFeed"></div>
  </div>
</div>

<script>
// ==============================
// FLOODGUARD KL 2050 ‚Äî FULL JS
// ==============================

const zones = [
  {id:'kl01',name:'Lembah Pantai',area:'WP Kuala Lumpur',state:'WPKL',lat:3.1074,lng:101.6745,risk:0,floodRisk:0.1,pop:95000},
  {id:'kl02',name:'Chow Kit',area:'WP Kuala Lumpur',state:'WPKL',lat:3.1696,lng:101.6970,risk:2,floodRisk:0.45,pop:72000},
  {id:'kl03',name:'Brickfields',area:'WP Kuala Lumpur',state:'WPKL',lat:3.1313,lng:101.6861,risk:1,floodRisk:0.2,pop:55000},
  {id:'kl04',name:'Titiwangsa',area:'WP Kuala Lumpur',state:'WPKL',lat:3.1756,lng:101.7076,risk:3,floodRisk:0.6,pop:63000},
  {id:'kl05',name:'Wangsa Maju',area:'WP Kuala Lumpur',state:'WPKL',lat:3.2041,lng:101.7386,risk:1,floodRisk:0.25,pop:88000},
  {id:'kl06',name:'Kepong',area:'WP Kuala Lumpur',state:'WPKL',lat:3.2175,lng:101.6368,risk:2,floodRisk:0.42,pop:112000},
  {id:'kl07',name:'Keramat',area:'WP Kuala Lumpur',state:'WPKL',lat:3.1847,lng:101.7249,risk:1,floodRisk:0.3,pop:67000},
  {id:'kl08',name:'Segambut',area:'WP Kuala Lumpur',state:'WPKL',lat:3.1949,lng:101.6698,risk:0,floodRisk:0.15,pop:45000},
  {id:'kl09',name:'Seputeh',area:'WP Kuala Lumpur',state:'WPKL',lat:3.1050,lng:101.6921,risk:0,floodRisk:0.1,pop:38000},
  {id:'kl10',name:'Bandar Tun Razak',area:'WP Kuala Lumpur',state:'WPKL',lat:3.0920,lng:101.7185,risk:3,floodRisk:0.65,pop:58000},
  {id:'ph01',name:'Ampang',area:'Ulu Langat',state:'SELANGOR',lat:3.1480,lng:101.7637,risk:4,floodRisk:0.85,pop:143000},
  {id:'ph02',name:'Gombak',area:'Gombak',state:'SELANGOR',lat:3.2530,lng:101.7014,risk:3,floodRisk:0.7,pop:98000},
  {id:'ph03',name:'Batu Caves',area:'Gombak',state:'SELANGOR',lat:3.2378,lng:101.6838,risk:3,floodRisk:0.68,pop:74000},
  {id:'ph04',name:'Shah Alam',area:'Petaling',state:'SELANGOR',lat:3.0738,lng:101.5183,risk:2,floodRisk:0.48,pop:241000},
  {id:'ph05',name:'Subang Jaya',area:'Petaling',state:'SELANGOR',lat:3.0521,lng:101.5904,risk:1,floodRisk:0.22,pop:165000},
  {id:'ph06',name:'Petaling Jaya',area:'Petaling',state:'SELANGOR',lat:3.1073,lng:101.6067,risk:2,floodRisk:0.4,pop:189000},
  {id:'ph07',name:'Klang',area:'Klang',state:'SELANGOR',lat:3.0449,lng:101.4456,risk:4,floodRisk:0.88,pop:239000},
  {id:'ph08',name:'Rawang',area:'Gombak',state:'SELANGOR',lat:3.3294,lng:101.5764,risk:2,floodRisk:0.38,pop:95000},
  {id:'ph09',name:'Sepang',area:'Sepang',state:'SELANGOR',lat:2.8654,lng:101.7147,risk:3,floodRisk:0.72,pop:86000},
  {id:'ph10',name:'Kajang',area:'Ulu Langat',state:'SELANGOR',lat:2.9924,lng:101.7868,risk:1,floodRisk:0.28,pop:115000},
  {id:'ph11',name:'Puchong',area:'Petaling',state:'SELANGOR',lat:3.0263,lng:101.6197,risk:2,floodRisk:0.45,pop:138000},
  {id:'ph12',name:'Hulu Langat',area:'Ulu Langat',state:'SELANGOR',lat:3.1007,lng:101.8325,risk:4,floodRisk:0.9,pop:62000},
  {id:'ph13',name:'Kuala Selangor',area:'Kuala Selangor',state:'SELANGOR',lat:3.3393,lng:101.2454,risk:3,floodRisk:0.65,pop:48000},
  {id:'ph14',name:'Sabak Bernam',area:'Sabak Bernam',state:'SELANGOR',lat:3.7744,lng:100.9843,risk:2,floodRisk:0.5,pop:72000},
  {id:'ns01',name:'Seremban',area:'Seremban',state:'N. SEMBILAN',lat:2.7260,lng:101.9374,risk:1,floodRisk:0.3,pop:344000},
  {id:'ns02',name:'Port Dickson',area:'Port Dickson',state:'N. SEMBILAN',lat:2.5228,lng:101.7947,risk:2,floodRisk:0.55,pop:98000},
  {id:'ns03',name:'Nilai',area:'Seremban',state:'N. SEMBILAN',lat:2.8108,lng:101.7993,risk:1,floodRisk:0.2,pop:112000},
  {id:'ns04',name:'Kuala Pilah',area:'Kuala Pilah',state:'N. SEMBILAN',lat:2.7374,lng:102.2476,risk:3,floodRisk:0.7,pop:53000},
  {id:'jh01',name:'Johor Bahru',area:'Johor Bahru',state:'JOHOR',lat:1.4927,lng:103.7414,risk:4,floodRisk:0.82,pop:497000},
  {id:'jh02',name:'Kota Tinggi',area:'Kota Tinggi',state:'JOHOR',lat:1.7373,lng:103.9007,risk:4,floodRisk:0.92,pop:89000},
  {id:'jh03',name:'Muar',area:'Muar',state:'JOHOR',lat:2.0444,lng:102.5689,risk:3,floodRisk:0.68,pop:114000},
  {id:'jh04',name:'Batu Pahat',area:'Batu Pahat',state:'JOHOR',lat:1.8545,lng:102.9328,risk:3,floodRisk:0.74,pop:128000},
  {id:'jh05',name:'Kluang',area:'Kluang',state:'JOHOR',lat:2.0252,lng:103.3253,risk:2,floodRisk:0.48,pop:96000},
  {id:'pg01',name:'Georgetown',area:'Timur Laut',state:'PENANG',lat:5.4141,lng:100.3288,risk:2,floodRisk:0.52,pop:350000},
  {id:'pg02',name:'Seberang Perai',area:'Seberang Perai Tengah',state:'PENANG',lat:5.3884,lng:100.3952,risk:3,floodRisk:0.69,pop:412000},
  {id:'pg03',name:'Butterworth',area:'Seberang Perai Utara',state:'PENANG',lat:5.3993,lng:100.3637,risk:2,floodRisk:0.44,pop:165000},
  {id:'pg04',name:'Bukit Mertajam',area:'Seberang Perai Tengah',state:'PENANG',lat:5.3641,lng:100.4589,risk:1,floodRisk:0.28,pop:133000},
  {id:'ph15',name:'Kota Bharu',area:'Kota Bharu',state:'KELANTAN',lat:6.1248,lng:102.2379,risk:4,floodRisk:0.91,pop:295000},
  {id:'ph16',name:'Kuala Krai',area:'Kuala Krai',state:'KELANTAN',lat:5.5271,lng:102.1986,risk:4,floodRisk:0.95,pop:67000},
  {id:'ph17',name:'Gua Musang',area:'Gua Musang',state:'KELANTAN',lat:4.8832,lng:101.9627,risk:3,floodRisk:0.75,pop:52000},
  {id:'ph18',name:'Kuala Terengganu',area:'Kuala Terengganu',state:'TERENGGANU',lat:5.3296,lng:103.1370,risk:4,floodRisk:0.86,pop:180000},
  {id:'ph19',name:'Kemaman',area:'Kemaman',state:'TERENGGANU',lat:4.2342,lng:103.4188,risk:3,floodRisk:0.7,pop:93000},
  {id:'ph20',name:'Kuantan',area:'Kuantan',state:'PAHANG',lat:3.8077,lng:103.3260,risk:3,floodRisk:0.72,pop:341000},
  {id:'ph21',name:'Rompin',area:'Rompin',state:'PAHANG',lat:2.8028,lng:103.4961,risk:4,floodRisk:0.88,pop:58000},
  {id:'ph22',name:'Temerloh',area:'Temerloh',state:'PAHANG',lat:3.4505,lng:102.4183,risk:3,floodRisk:0.67,pop:97000},
  {id:'ph23',name:'Ipoh',area:'Kinta',state:'PERAK',lat:4.5975,lng:101.0901,risk:2,floodRisk:0.5,pop:657000},
  {id:'ph24',name:'Teluk Intan',area:'Hilir Perak',state:'PERAK',lat:4.0240,lng:101.0213,risk:3,floodRisk:0.76,pop:113000},
  {id:'ph25',name:'Taiping',area:'Larut Matang',state:'PERAK',lat:4.8512,lng:100.7462,risk:2,floodRisk:0.45,pop:185000},
  {id:'ph26',name:'Alor Setar',area:'Kota Setar',state:'KEDAH',lat:6.1256,lng:100.3673,risk:3,floodRisk:0.69,pop:291000},
  {id:'ph27',name:'Sungai Petani',area:'Kuala Muda',state:'KEDAH',lat:5.6476,lng:100.4885,risk:2,floodRisk:0.48,pop:271000},
  {id:'ph28',name:'Kulim',area:'Kulim',state:'KEDAH',lat:5.3781,lng:100.5509,risk:2,floodRisk:0.42,pop:145000},
  {id:'ph29',name:'Kuching',area:'Kuching',state:'SARAWAK',lat:1.5533,lng:110.3592,risk:3,floodRisk:0.7,pop:325000},
  {id:'ph30',name:'Sibu',area:'Sibu',state:'SARAWAK',lat:2.2928,lng:111.8248,risk:4,floodRisk:0.87,pop:162000},
  {id:'ph31',name:'Bintulu',area:'Bintulu',state:'SARAWAK',lat:3.1667,lng:113.0333,risk:3,floodRisk:0.65,pop:194000},
  {id:'ph32',name:'Kota Kinabalu',area:'Kota Kinabalu',state:'SABAH',lat:5.9804,lng:116.0735,risk:2,floodRisk:0.46,pop:452000},
  {id:'ph33',name:'Sandakan',area:'Sandakan',state:'SABAH',lat:5.8456,lng:118.1179,risk:3,floodRisk:0.71,pop:148000},
  {id:'ph34',name:'Keningau',area:'Keningau',state:'SABAH',lat:5.3376,lng:116.1616,risk:3,floodRisk:0.68,pop:84000},
  {id:'ph35',name:'Penampang',area:'Penampang',state:'SABAH',lat:5.9247,lng:116.0703,risk:2,floodRisk:0.44,pop:126000},
  {id:'ph36',name:'Tawau',area:'Tawau',state:'SABAH',lat:4.2449,lng:117.8910,risk:2,floodRisk:0.5,pop:145000},
  {id:'ph37',name:'Kangar',area:'Perlis Indera Kayangan',state:'PERLIS',lat:6.4419,lng:100.1984,risk:2,floodRisk:0.55,pop:45000},
  {id:'ph38',name:'Arau',area:'Arau',state:'PERLIS',lat:6.4260,lng:100.2747,risk:1,floodRisk:0.3,pop:22000},
  {id:'ph39',name:'Melaka Tengah',area:'Melaka Tengah',state:'MELAKA',lat:2.2042,lng:102.2405,risk:2,floodRisk:0.47,pop:382000},
  {id:'ph40',name:'Jasin',area:'Jasin',state:'MELAKA',lat:2.3075,lng:102.4355,risk:2,floodRisk:0.4,pop:63000},
  {id:'ph41',name:'Nilai Utama',area:'Nilai',state:'N. SEMBILAN',lat:2.8297,lng:101.7802,risk:1,floodRisk:0.22,pop:78000},
  {id:'ph42',name:'Hulu Selangor',area:'Hulu Selangor',state:'SELANGOR',lat:3.5707,lng:101.6483,risk:2,floodRisk:0.45,pop:68000},
  {id:'ph43',name:'Bentong',area:'Bentong',state:'PAHANG',lat:3.5241,lng:101.9084,risk:3,floodRisk:0.63,pop:73000},
  {id:'ph44',name:'Labuan',area:'WP Labuan',state:'WPLABUAN',lat:5.2817,lng:115.2360,risk:2,floodRisk:0.5,pop:95000},
  {id:'ph45',name:'Putrajaya',area:'WP Putrajaya',state:'WPPUTRAJAYA',lat:2.9264,lng:101.6964,risk:1,floodRisk:0.18,pop:109000},
  {id:'ph46',name:'KL Utara',area:'WP Kuala Lumpur',state:'WPKL',lat:3.2095,lng:101.6765,risk:2,floodRisk:0.42,pop:98000},
  {id:'ph47',name:'Cheras',area:'WP Kuala Lumpur',state:'WPKL',lat:3.0796,lng:101.7498,risk:3,floodRisk:0.66,pop:115000},
  {id:'ph48',name:'Sri Hartamas',area:'WP Kuala Lumpur',state:'WPKL',lat:3.1656,lng:101.6585,risk:0,floodRisk:0.12,pop:35000},
  {id:'ph49',name:'Damansara',area:'Petaling',state:'SELANGOR',lat:3.1519,lng:101.6237,risk:1,floodRisk:0.24,pop:72000},
  {id:'ph50',name:'Bangsar',area:'WP Kuala Lumpur',state:'WPKL',lat:3.1197,lng:101.6734,risk:0,floodRisk:0.13,pop:44000},
  {id:'ph51',name:'Klang Utara',area:'Klang',state:'SELANGOR',lat:3.0820,lng:101.4410,risk:3,floodRisk:0.7,pop:88000},
  {id:'ph52',name:'Kapar',area:'Klang',state:'SELANGOR',lat:3.0994,lng:101.4075,risk:4,floodRisk:0.85,pop:52000},
  {id:'ph53',name:'KL Selatan',area:'WP Kuala Lumpur',state:'WPKL',lat:3.0870,lng:101.7010,risk:2,floodRisk:0.44,pop:82000},
  {id:'ph54',name:'Seri Kembangan',area:'Petaling',state:'SELANGOR',lat:3.0359,lng:101.7075,risk:2,floodRisk:0.46,pop:93000},
  {id:'ph55',name:'Beranang',area:'Ulu Langat',state:'SELANGOR',lat:2.8765,lng:101.8598,risk:2,floodRisk:0.48,pop:38000},
  {id:'ph56',name:'Tumpat',area:'Tumpat',state:'KELANTAN',lat:6.1985,lng:102.1703,risk:4,floodRisk:0.93,pop:78000},
  {id:'ph57',name:'Pasir Mas',area:'Pasir Mas',state:'KELANTAN',lat:6.0432,lng:102.1396,risk:4,floodRisk:0.9,pop:89000},
  {id:'ph58',name:'Dungun',area:'Dungun',state:'TERENGGANU',lat:4.7559,lng:103.4142,risk:3,floodRisk:0.68,pop:75000},
  {id:'ph59',name:'Setiu',area:'Setiu',state:'TERENGGANU',lat:5.6780,lng:102.7360,risk:3,floodRisk:0.71,pop:42000},
  {id:'ph60',name:'Raub',area:'Raub',state:'PAHANG',lat:3.7899,lng:101.8600,risk:2,floodRisk:0.5,pop:56000},
  {id:'ph61',name:'Jerantut',area:'Jerantut',state:'PAHANG',lat:3.9325,lng:102.3601,risk:3,floodRisk:0.65,pop:62000},
  {id:'ph62',name:'Cameron Highlands',area:'Cameron Highlands',state:'PAHANG',lat:4.4714,lng:101.3770,risk:2,floodRisk:0.55,pop:32000},
  {id:'ph63',name:'Setiawan',area:'Manjung',state:'PERAK',lat:4.2124,lng:100.6996,risk:2,floodRisk:0.5,pop:98000},
  {id:'ph64',name:'Manjung',area:'Manjung',state:'PERAK',lat:4.2285,lng:100.6498,risk:2,floodRisk:0.52,pop:156000},
  {id:'ph65',name:'Kuala Kangsar',area:'Kuala Kangsar',state:'PERAK',lat:4.7681,lng:100.9347,risk:2,floodRisk:0.45,pop:68000},
  {id:'ph66',name:'Kubang Pasu',area:'Kubang Pasu',state:'KEDAH',lat:6.2073,lng:100.5608,risk:3,floodRisk:0.67,pop:84000},
  {id:'ph67',name:'Baling',area:'Baling',state:'KEDAH',lat:5.7079,lng:100.9164,risk:3,floodRisk:0.65,pop:95000},
  {id:'ph68',name:'Miri',area:'Miri',state:'SARAWAK',lat:4.3995,lng:113.9914,risk:2,floodRisk:0.48,pop:300000},
  {id:'ph69',name:'Serian',area:'Serian',state:'SARAWAK',lat:1.1727,lng:110.5729,risk:3,floodRisk:0.7,pop:58000},
  {id:'ph70',name:'Beaufort',area:'Beaufort',state:'SABAH',lat:5.3539,lng:115.7468,risk:3,floodRisk:0.73,pop:37000},
  {id:'ph71',name:'Papar',area:'Papar',state:'SABAH',lat:5.7326,lng:116.0155,risk:2,floodRisk:0.5,pop:52000},
  {id:'ph72',name:'Semporna',area:'Semporna',state:'SABAH',lat:4.4873,lng:118.6097,risk:2,floodRisk:0.48,pop:90000}
];

const rivers=[
  {name:'Sg. Gombak',baseLevel:1.2,maxLevel:7.5,dangerLevel:5.5,lat:3.1720,lng:101.6980},
  {name:'Sg. Klang',baseLevel:2.0,maxLevel:9.0,dangerLevel:6.5,lat:3.1450,lng:101.7020},
  {name:'Sg. Batu',baseLevel:0.8,maxLevel:5.0,dangerLevel:3.5,lat:3.1920,lng:101.6780},
  {name:'Sg. Kerayong',baseLevel:1.5,maxLevel:6.0,dangerLevel:4.5,lat:3.1100,lng:101.7150}
];

const evakRoutes=[
  {name:'MRR2 Northbound',detail:'Via Jln Gombak ‚Üí Jln Pahang',status:'open'},
  {name:'NKVE to Subang',detail:'Via Kota Damansara Interchange',status:'open'},
  {name:'Duke Highway East',detail:'Via Jln Ampang ‚Üí KL East',status:'caution'},
  {name:'LDP Southbound',detail:'Damansara Perdana exit',status:'open'},
  {name:'KESAS Highway',detail:'Via Shah Alam ‚Üí Klang',status:'closed'},
  {name:'Sprint Highway',detail:'Kerinchi Link ‚Üí Pantai',status:'open'}
];

const alertMessages=[
  {msg:'Water level at Sg. Gombak Station rising. Current: 3.2m above normal.',time:'12:43',type:'warning'},
  {msg:'SMART Tunnel activated. Motorists advised to avoid Jalan Tun Razak.',time:'12:38',type:'danger'},
  {msg:'Flood warning issued for Ampang and Cheras districts.',time:'12:31',type:'danger'},
  {msg:'Evacuation center at DBKL Shah Alam Hall is now open.',time:'12:24',type:'info'},
  {msg:'Rescue operation underway at Taman Desa Jaya. 12 residents evacuated.',time:'12:17',type:'warning'},
  {msg:'JKM deploys 4 rescue boats to Klang river basin.',time:'12:09',type:'info'},
  {msg:'Road closure: Jln Pahang at KM 4.2 due to 0.8m floodwater.',time:'12:02',type:'warning'},
  {msg:'Rainfall intensity: 87mm/hr at Chow Kit monitoring station.',time:'11:55',type:'info'},
  {msg:'DBKL pumping stations operating at 95% capacity.',time:'11:48',type:'info'},
  {msg:'Flash flood advisory extended to include Segambut area.',time:'11:40',type:'warning'},
];
const dotColors={danger:'#ff2d55',warning:'#ff6b35',info:'#4fc3f7',safe:'#00e676'};

let currentLayer='flood';
let rainLevel=30;
let selectedZoneId=null;
let stateFilter='ALL';
let searchQuery='';
let markers={};
let zonePolygons={};
let routeLines=[];
let stationMarkers=[];
let openPanel=null;
let forecastHour=1;
let leafletMap;
let _currentSheetTab='stats';

// ---- INIT ----
function init(){
  leafletMap=L.map('map',{center:[3.8,109.0],zoom:6,zoomControl:true});
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap contributors',maxZoom:18}).addTo(leafletMap);
  buildZones();
  renderZoneList();
  buildStateFilter();
  updateStats(rainLevel);
  renderGauges();
  renderAlertFeed();
  updateBarChart();
  updateRoutePanel('kl');
  renderRadar();
  updateAIForecast();
  startClock();
  startAlertRotation();
  bindEvents();
  setTimeout(()=>renderSheetBody('stats'),600);
}

function bindEvents(){
  // Hamburger
  const hbtn=document.getElementById('hamburgerBtn');
  if(hbtn) hbtn.addEventListener('click',toggleDrawer);

  // Drawer overlay
  const ov=document.getElementById('drawerOverlay');
  if(ov) ov.addEventListener('click',closeDrawer);

  // Rain slider
  const rs=document.getElementById('rainSlider');
  if(rs){
    rs.addEventListener('input',function(){updateRain(this.value);});
    rs.addEventListener('change',function(){updateRain(this.value);});
  }

  // Search bar
  const sb=document.getElementById('searchBar');
  if(sb) sb.addEventListener('input',filterZones);

  // Map layer buttons
  document.getElementById('btn-flood').addEventListener('click',()=>setLayer('flood'));
  document.getElementById('btn-routes').addEventListener('click',()=>setLayer('routes'));
  document.getElementById('btn-stations').addEventListener('click',()=>setLayer('stations'));
  document.getElementById('btn-rain').addEventListener('click',()=>togglePanel('rain'));
  document.getElementById('btn-ai').addEventListener('click',()=>togglePanel('ai'));

  // Panel close buttons
  document.getElementById('closeRainPanel').addEventListener('click',()=>togglePanel('rain'));
  document.getElementById('closeAiPanel').addEventListener('click',()=>togglePanel('ai'));

  // Forecast tabs
  document.querySelectorAll('.ftab').forEach(btn=>{
    btn.addEventListener('click',function(){setForecastTab(parseInt(this.dataset.h));});
  });

  // Bottom nav
  document.getElementById('bnav-map').addEventListener('click',()=>mobileNav('map'));
  document.getElementById('bnav-rain').addEventListener('click',()=>mobileNav('rain-ctrl'));
  document.getElementById('bnav-stats').addEventListener('click',()=>mobileNav('stats'));
  document.getElementById('bnav-alerts').addEventListener('click',()=>mobileNav('alerts'));
  document.getElementById('bnav-routes').addEventListener('click',()=>mobileNav('routes'));

  // Sheet tabs
  document.getElementById('stab-stats').addEventListener('click',()=>switchSheetTab('stats'));
  document.getElementById('stab-gauges').addEventListener('click',()=>switchSheetTab('gauges'));
  document.getElementById('stab-risk').addEventListener('click',()=>switchSheetTab('risk'));
  document.getElementById('stab-routes').addEventListener('click',()=>switchSheetTab('routes'));
  document.getElementById('stab-alerts').addEventListener('click',()=>switchSheetTab('alerts'));

  // Sheet close & handle
  document.getElementById('sheetCloseBtn').addEventListener('click',closeSheet);
  document.getElementById('sheetHandle').addEventListener('click',closeSheet);

  // Resize
  window.addEventListener('resize',function(){
    if(window.innerWidth>=900){closeDrawer();closeSheet();}
    if(leafletMap) leafletMap.invalidateSize();
  });
}

function startClock(){
  const el=document.getElementById('clock');
  if(el) setInterval(()=>{el.textContent=new Date().toLocaleTimeString('en-MY',{hour12:false});},1000);
}

function buildZones(){
  zones.forEach(z=>{
    const latlng=[z.lat,z.lng];
    const colors=['#00e676','#4fc3f7','#ffd600','#ff6b35','#ff2d55'];
    const c=colors[z.risk]||'#00e676';
    const radius=8000+z.pop/8000;
    const circle=L.circle(latlng,{radius,color:c,fillColor:c,fillOpacity:0.35,weight:1.5,opacity:0.8}).addTo(leafletMap);
    circle.bindTooltip(`<div class="flood-tooltip-inner"><b>${z.name}</b><br>${z.area}, ${z.state}<br>Pop: ${(z.pop/1000).toFixed(0)}K ¬∑ Risk: ${['SAFE','LOW','WATCH','HIGH','FLOOD'][z.risk]}</div>`,{permanent:false,className:'flood-tooltip',sticky:true});
    circle.on('click',()=>selectZone(z.id));
    zonePolygons[z.id]=circle;
    const mk=L.circleMarker(latlng,{radius:5,color:'#000',fillColor:c,fillOpacity:1,weight:1}).addTo(leafletMap);
    mk.on('click',()=>selectZone(z.id));
    markers[z.id]=mk;
  });
}

function setLayer(layer){
  currentLayer=layer;
  ['flood','routes','stations'].forEach(l=>{
    const btn=document.getElementById('btn-'+l);
    if(btn) btn.classList.toggle('active',l===layer);
  });
  Object.values(zonePolygons).forEach(c=>{if(layer==='flood') c.addTo(leafletMap); else leafletMap.removeLayer(c);});
  Object.values(markers).forEach(m=>{if(layer==='flood') m.addTo(leafletMap); else leafletMap.removeLayer(m);});
  routeLines.forEach(l=>{if(layer==='routes') l.addTo(leafletMap); else leafletMap.removeLayer(l);});
  stationMarkers.forEach(m=>{if(layer==='stations') m.addTo(leafletMap); else leafletMap.removeLayer(m);});
  if(layer==='routes'&&routeLines.length===0) buildRouteLines();
  if(layer==='stations'&&stationMarkers.length===0) buildStationMarkers();
}

function buildRouteLines(){
  const routes=[
    [[3.172,101.698],[3.209,101.676],[3.252,101.701],[3.237,101.684]],
    [[3.145,101.702],[3.073,101.518],[3.052,101.590]],
    [[3.148,101.764],[3.183,101.725],[3.150,101.697]],
    [[3.092,101.719],[3.036,101.620],[3.026,101.585]]
  ];
  const colors=['#ff6b35','#00e676','#ffd600','#00e5ff'];
  routes.forEach((pts,i)=>{
    const l=L.polyline(pts,{color:colors[i],weight:3,opacity:0.85,dashArray:'8,4'});
    routeLines.push(l);
    if(currentLayer==='routes') l.addTo(leafletMap);
  });
}

function buildStationMarkers(){
  rivers.forEach(r=>{
    const m=L.marker([r.lat,r.lng],{icon:L.divIcon({className:'',html:'<div style="width:16px;height:16px;background:#4fc3f7;border:2px solid #fff;border-radius:50%;box-shadow:0 0 10px #4fc3f7;"></div>',iconSize:[16,16],iconAnchor:[8,8]})});
    m.bindTooltip(`<div class="flood-tooltip-inner"><b>üì° ${r.name}</b><br>Station: Active</div>`,{permanent:false,className:'flood-tooltip'});
    stationMarkers.push(m);
    if(currentLayer==='stations') m.addTo(leafletMap);
  });
}

function selectZone(id){
  selectedZoneId=id;
  const z=zones.find(z=>z.id===id);
  if(!z) return;
  document.querySelectorAll('.zone-item').forEach(el=>el.classList.remove('active'));
  const el=document.querySelector(`[data-id="${id}"]`);
  if(el){el.classList.add('active');el.scrollIntoView({behavior:'smooth',block:'nearest'});}
  leafletMap.flyTo([z.lat,z.lng],12,{animate:true,duration:1.2});
  updateRoutePanel(z.id,z.name,z.state);
  const rs=document.getElementById('routeSection');
  if(rs) rs.textContent=`Evacuation Routes (${z.name})`;
  if(window.innerWidth<900) closeDrawer();
}

function updateRain(val){
  rainLevel=parseInt(val);
  const el=document.getElementById('rainVal');
  if(el) el.textContent=val;
  const pct=(val/200)*100;
  const slider=document.getElementById('rainSlider');
  if(slider) slider.style.background=`linear-gradient(to right,var(--accent-cyan) 0%,var(--accent-cyan) ${pct}%,var(--border) ${pct}%)`;
  updateStats(val);
  updateZoneRisks(val);
  renderGauges();
  updateBarChart();
  updateAlertCard(val);
  updateRadar();
  updateAIForecast();
  const sheet=document.getElementById('statsSheet');
  if(sheet&&sheet.classList.contains('open')) renderSheetBody(_currentSheetTab);
}

function updateZoneRisks(rain){
  const mm=parseInt(rain);
  zones.forEach(z=>{
    const fr=z.floodRisk;
    const base=fr*4;
    const rainFactor=(mm/200)*4;
    const combined=(base*0.6+rainFactor*0.4);
    z.risk=Math.min(4,Math.round(combined));
    const colors=['#00e676','#4fc3f7','#ffd600','#ff6b35','#ff2d55'];
    const c=colors[z.risk];
    if(zonePolygons[z.id]) zonePolygons[z.id].setStyle({color:c,fillColor:c});
    if(markers[z.id]) markers[z.id].setStyle({fillColor:c});
  });
  renderZoneList();
}

function updateStats(rain){
  const mm=parseInt(rain);
  updateZoneRisks(mm);
  const flooded=zones.filter(z=>z.risk>=4).length;
  const atRisk=zones.filter(z=>z.risk>=2&&z.risk<4).length;
  const totalPop=zones.filter(z=>z.risk>=2).reduce((s,z)=>s+z.pop,0);
  const openR=evakRoutes.filter(r=>r.status==='open').length;
  const ps=totalPop>=1000000?(totalPop/1000000).toFixed(1)+'M':totalPop>1000?(totalPop/1000).toFixed(0)+'K':totalPop;
  const sf=document.getElementById('statFlooded');
  const sr=document.getElementById('statRisk');
  const sp=document.getElementById('statPop');
  const sor=document.getElementById('statRoutes');
  if(sf) sf.textContent=flooded;
  if(sr) sr.textContent=atRisk;
  if(sp) sp.textContent=ps;
  if(sor) sor.textContent=openR;
}

function renderGauges(){
  const container=document.getElementById('gaugeList');
  if(!container) return;
  container.innerHTML=rivers.map(r=>{
    const lv=Math.min(r.maxLevel,r.baseLevel+(rainLevel/200)*r.maxLevel*0.9);
    const pct=Math.min(100,(lv/r.maxLevel)*100);
    const c=pct>80?'#ff2d55':pct>60?'#ff6b35':pct>40?'#ffd600':'#00e676';
    return `<div class="gauge-row"><span class="gauge-name">${r.name}</span><div class="gauge-bar-wrap"><div class="gauge-bar-fill" style="width:${pct}%;background:${c};"></div></div><span class="gauge-pct" style="color:${c}">${lv.toFixed(1)}m</span></div>`;
  }).join('');
}

function updateBarChart(){
  const container=document.getElementById('barChartContent');
  if(!container) return;
  const sorted=[...zones].sort((a,b)=>b.risk-a.risk||b.floodRisk-a.floodRisk).slice(0,8);
  container.innerHTML=sorted.map(z=>{
    const pct=[0,25,50,75,100][z.risk];
    const color=['#00e676','#4fc3f7','#ffd600','#ff6b35','#ff2d55'][z.risk];
    return `<div class="bar-row"><span class="bar-name">${z.name}</span><div class="bar-track"><div class="bar-fill" style="width:${pct}%;background:${color}"></div></div><span class="bar-pct" style="color:${color}">${pct}%</span></div>`;
  }).join('');
}

function getEvakRoutes(zoneId,state){
  const byState={
    'KELANTAN':[{name:'East Coast Expressway (LPT)',detail:'Via Kota Bharu North',status:'caution'},{name:'Jln Pasir Mas',detail:'Bridge 3 open',status:'open'},{name:'Jln Kuala Krai',detail:'Highland route',status:'open'}],
    'TERENGGANU':[{name:'LPT2 Highway',detail:'Towards KL direction',status:'open'},{name:'Jln Kemasik',detail:'Coastal bypass',status:'caution'},{name:'Jln Chukai',detail:'River crossing OK',status:'open'}],
    'JOHOR':[{name:'North-South Highway',detail:'Via Senai interchange',status:'open'},{name:'Jln Kota Tinggi',detail:'Monitor water level',status:'caution'},{name:'Jln Mersing',detail:'Detour advised',status:'closed'}],
    'PAHANG':[{name:'East Coast Expressway',detail:'Main artery clear',status:'open'},{name:'Jln Kuantan-KL',detail:'Via Bentong Pass',status:'caution'},{name:'Jln Rompin',detail:'Flooded ‚Äî avoid',status:'closed'}],
    'SELANGOR':[{name:'NKVE Highway',detail:'All lanes clear',status:'open'},{name:'LDP Expressway',detail:'Puchong section congested',status:'caution'},{name:'KESAS Highway',detail:'Klang section flooded',status:'closed'}],
    'PENANG':[{name:'E1 North-South Highway',detail:'Via Butterworth interchange',status:'open'},{name:'Penang Bridge',detail:'Standard flow',status:'open'},{name:'Jln Perai',detail:'Industrial bypass',status:'caution'}],
    'SABAH':[{name:'Jalan Mat Salleh',detail:'Via Kota Belud',status:'open'},{name:'Pan Borneo Highway',detail:'Km 45 monitoring',status:'caution'},{name:'Jln Sandakan',detail:'Landslide risk high',status:'closed'}],
    'SARAWAK':[{name:'Pan Borneo Sarawak',detail:'Main Kuching-Sibu route',status:'open'},{name:'Jln Kuching-Serian',detail:'River overflow risk',status:'caution'},{name:'Jln Kuching-Bau',detail:'Clear',status:'open'}],
    'PERAK':[{name:'North-South Highway',detail:'All clear',status:'open'},{name:'Jln Ipoh-Lumut',detail:'Banjir at KM 22',status:'caution'},{name:'Jln Pengkalan Hulu',detail:'Border route',status:'open'}],
    'KEDAH':[{name:'North-South Highway',detail:'Alor Setar exit',status:'open'},{name:'Jln Alor Setar-Baling',detail:'Watch for flood',status:'caution'},{name:'Jln Kubang Pasu',detail:'Clear',status:'open'}],
  };
  return byState[state]||evakRoutes;
}

function updateRoutePanel(zoneId,zoneName,state){
  const container=document.getElementById('routeList');
  if(!container) return;
  const routes=(zoneId&&state)?getEvakRoutes(zoneId,state):evakRoutes;
  container.innerHTML=routes.map((r,i)=>`<div class="route-item"><div class="route-num">${i+1}</div><div class="route-info"><div class="route-name">${r.name}</div><div class="route-detail">${r.detail}</div></div><span class="route-status route-${r.status}">${r.status.toUpperCase()}</span></div>`).join('');
}

function renderAlertFeed(){
  const feed=document.getElementById('alertFeed');
  if(!feed) return;
  feed.innerHTML=alertMessages.map(a=>`<div class="alert-item"><div class="alert-dot" style="background:${dotColors[a.type]||'#00e5ff'}"></div><div class="alert-content"><div class="alert-msg">${a.msg}</div><div class="alert-time">${a.time}</div></div></div>`).join('');
}

function startAlertRotation(){
  setInterval(()=>{
    const now=new Date();
    const t=`${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
    const msgs=[
      'Automated sensor check complete. All 142 stations reporting.',
      'Water level at Sg. Batu rising 0.3m in last 15 minutes.',
      'NADMA advisory: Check your nearest flood evacuation center.',
      `Rainfall forecast: ${rainLevel>100?'Heavy to very heavy':rainLevel>50?'Moderate to heavy':'Light to moderate'} rain expected in next 2 hours.`,
      'DID Klang Valley flood portal updated with latest readings.',
    ];
    const msg=msgs[Math.floor(Math.random()*msgs.length)];
    alertMessages.unshift({msg,time:t,type:rainLevel>100?'warning':'info'});
    if(alertMessages.length>12) alertMessages.pop();
    renderAlertFeed();
    const sheet=document.getElementById('statsSheet');
    if(sheet&&sheet.classList.contains('open')&&_currentSheetTab==='alerts') renderSheetBody('alerts');
  },15000);
}

function updateAlertCard(val){
  const mm=parseInt(val);
  const card=document.getElementById('alertCard');
  const title=document.getElementById('alertTitle');
  const desc=document.getElementById('alertDesc');
  if(!card||!title||!desc) return;
  card.className='alert-card';
  if(mm<25){card.classList.add('normal');title.textContent='‚óè NORMAL';desc.textContent='Rainfall within safe parameters. All monitoring stations operational.';}
  else if(mm<75){card.classList.add('watch');title.textContent='‚óâ WATCH';desc.textContent='Moderate rainfall detected. Monitoring stations on alert. Flood risk elevated in low-lying areas.';}
  else if(mm<125){card.classList.add('warning');title.textContent='‚ö† WARNING';desc.textContent='Heavy rainfall. Multiple zones at elevated risk. Evacuation on standby. Monitor water levels closely.';}
  else{card.classList.add('danger');title.textContent='‚ú¶ DANGER';desc.textContent='EXTREME RAINFALL. Immediate evacuation recommended for flood-prone areas. Emergency services activated.';}
  const dot=document.getElementById('systemDot');
  const status=document.getElementById('systemStatus');
  if(dot&&status){
    if(mm>=125){dot.style.background='#ff2d55';dot.style.boxShadow='var(--glow-red)';status.textContent='EMERGENCY MODE';status.style.color='#ff2d55';}
    else if(mm>=75){dot.style.background='#ff6b35';dot.style.boxShadow='';status.textContent='ALERT MODE';status.style.color='#ff6b35';}
    else{dot.style.background='var(--accent-green)';dot.style.boxShadow='var(--glow-green)';status.textContent='SYSTEM ONLINE';status.style.color='var(--accent-green)';}
  }
}

function renderZoneList(){
  const container=document.getElementById('zoneList');
  if(!container) return;
  let filtered=zones;
  if(stateFilter!=='ALL') filtered=filtered.filter(z=>z.state===stateFilter);
  if(searchQuery){const q=searchQuery.toLowerCase();filtered=filtered.filter(z=>z.name.toLowerCase().includes(q)||z.area.toLowerCase().includes(q)||z.state.toLowerCase().includes(q));}
  filtered=filtered.sort((a,b)=>b.risk-a.risk);
  const badge=document.getElementById('zoneCountBadge');
  if(badge) badge.textContent=`${filtered.length} DAERAH`;
  container.innerHTML=filtered.map(z=>{
    const badges=['badge-safe','badge-safe','badge-watch','badge-risk','badge-flood'];
    const labels=['SAFE','LOW','WATCH','HIGH','FLOOD'];
    return `<div class="zone-item ${selectedZoneId===z.id?'active':''}" data-id="${z.id}"><div><div class="zone-name">${z.name}</div><div class="zone-area">${z.area} ¬∑ ${z.state}</div></div><span class="zone-badge ${badges[z.risk]}">${labels[z.risk]}</span></div>`;
  }).join('');
  // Re-attach click events via event delegation
  container.querySelectorAll('.zone-item').forEach(el=>{
    el.addEventListener('click',function(){selectZone(this.dataset.id);});
  });
}

function buildStateFilter(){
  const states=[...new Set(zones.map(z=>z.state))].sort();
  const container=document.getElementById('stateFilter');
  if(!container) return;
  container.innerHTML='<button class="state-btn active">ALL</button>';
  states.forEach(s=>{container.innerHTML+=`<button class="state-btn">${s}</button>`;});
  container.querySelectorAll('.state-btn').forEach(btn=>{
    btn.addEventListener('click',function(){setStateFilter(this.textContent);});
  });
}

function setStateFilter(state){
  stateFilter=state;
  document.querySelectorAll('.state-btn').forEach(b=>{b.classList.toggle('active',b.textContent===state);});
  renderZoneList();
}

function filterZones(){
  const sb=document.getElementById('searchBar');
  if(sb) searchQuery=sb.value;
  renderZoneList();
}

function renderRadar(){
  const grid=document.getElementById('radarGrid');
  if(!grid) return;
  grid.innerHTML='';
  for(let i=0;i<48;i++){
    const div=document.createElement('div');
    div.className='radar-cell';
    div.style.background=rainToColor(Math.random()*rainLevel*1.2);
    grid.appendChild(div);
  }
  updateRadarStats();
}

function updateRadar(){
  document.querySelectorAll('.radar-cell').forEach(c=>{c.style.background=rainToColor(Math.random()*rainLevel*1.2);});
  updateRadarStats();
}

function updateRadarStats(){
  const statsRow=document.getElementById('rainStatsRow');
  if(statsRow) statsRow.innerHTML=`<div class="rain-stat-item"><div class="rain-stat-val">${rainLevel}</div><div class="rain-stat-lbl">CURRENT mm/hr</div></div><div class="rain-stat-item"><div class="rain-stat-val">${Math.round(rainLevel*1.15)}</div><div class="rain-stat-lbl">PEAK mm/hr</div></div><div class="rain-stat-item"><div class="rain-stat-val">${Math.round(rainLevel*0.6)}</div><div class="rain-stat-lbl">AVG mm/hr</div></div><div class="rain-stat-item"><div class="rain-stat-val">${(rainLevel*0.15).toFixed(1)}</div><div class="rain-stat-lbl">ACCUM mm</div></div>`;
  const ts=document.getElementById('radarTimestamp');
  if(ts) ts.textContent=new Date().toLocaleTimeString('en-MY',{hour12:false});
}

function rainToColor(mm){
  if(mm<5) return '#020c18';
  if(mm<15) return '#071f3a';
  if(mm<30) return '#0d3a5c';
  if(mm<50) return '#1565c0';
  if(mm<75) return '#4fc3f7';
  if(mm<100) return '#ffd600';
  if(mm<140) return '#ff6b35';
  return '#ff2d55';
}

function setForecastTab(h){
  forecastHour=h;
  document.querySelectorAll('.ftab').forEach(b=>{b.classList.toggle('active',parseInt(b.dataset.h)===h);});
  updateAIForecast();
}

function updateAIForecast(){
  const content=document.getElementById('forecastContent');
  if(!content) return;
  const multiplier={1:1,3:1.15,6:1.3,12:1.5,24:1.7}[forecastHour]||1;
  const topZones=[...zones].sort((a,b)=>(b.floodRisk*b.pop)-(a.floodRisk*a.pop)).slice(0,8);
  content.innerHTML=topZones.map(z=>{
    const pct=Math.min(100,Math.round(z.floodRisk*100*multiplier*(1+rainLevel/400)));
    const c=pct>75?'#ff2d55':pct>50?'#ff6b35':pct>30?'#ffd600':'#4fc3f7';
    return `<div class="forecast-zone-row"><span class="fz-name">${z.name}</span><div class="fz-bar-wrap"><div class="fz-bar" style="width:${pct}%;background:${c}"></div></div><span class="fz-risk" style="color:${c}">${pct}%</span></div>`;
  }).join('');
  const conf=Math.max(60,95-forecastHour*1.5-(rainLevel>100?5:0));
  const cb=document.getElementById('confBar');
  const cp=document.getElementById('confPct');
  if(cb) cb.style.width=conf+'%';
  if(cp) cp.textContent=Math.round(conf)+'%';
  const warnBox=document.getElementById('aiWarningBox');
  if(warnBox){
    const maxRisk=Math.max(...topZones.map(z=>z.floodRisk));
    if(rainLevel>125||maxRisk>0.85){warnBox.className='ai-warning-box warn-danger';warnBox.textContent=`‚ö† HIGH FLOOD PROBABILITY in ${forecastHour}H. Immediate precautionary measures advised.`;}
    else if(rainLevel>60||maxRisk>0.6){warnBox.className='ai-warning-box warn-caution';warnBox.textContent=`‚óâ ELEVATED RISK in ${forecastHour}H window. Monitor conditions closely.`;}
    else{warnBox.className='ai-warning-box warn-ok';warnBox.textContent=`‚úì LOW-MODERATE risk in ${forecastHour}H. Standard monitoring active.`;}
  }
  const aiTs=document.getElementById('aiUpdateTime');
  if(aiTs) aiTs.textContent=new Date().toLocaleTimeString('en-MY',{hour12:false});
  const chart=document.getElementById('forecastChart');
  if(chart){
    const hours=[1,3,6,12,24];
    chart.innerHTML=hours.map(h=>{
      const mult={1:1,3:1.15,6:1.3,12:1.5,24:1.7}[h]||1;
      const avgRisk=zones.reduce((s,z)=>s+z.floodRisk*mult*(1+rainLevel/400),0)/zones.length;
      const ht=Math.min(95,Math.round(avgRisk*90));
      const c=ht>70?'#ff2d55':ht>45?'#ff6b35':ht>25?'#ffd600':'#4fc3f7';
      return `<div class="fc-bar-wrap"><div class="fc-bar" style="height:${ht}%;background:${c}"></div><span class="fc-time">+${h}H</span></div>`;
    }).join('');
  }
}

function togglePanel(name){
  const panelId='panel-'+name;
  const btnId='btn-'+name;
  const panel=document.getElementById(panelId);
  const btn=document.getElementById(btnId);
  if(!panel) return;
  if(openPanel&&openPanel!==panelId){
    const old=document.getElementById(openPanel);
    if(old) old.style.display='none';
    const oldBtn=document.getElementById(openPanel.replace('panel-','btn-'));
    if(oldBtn) oldBtn.classList.remove('panel-open');
  }
  const isOpen=panel.style.display!=='none';
  panel.style.display=isOpen?'none':'flex';
  if(btn) btn.classList.toggle('panel-open',!isOpen);
  openPanel=isOpen?null:panelId;
}

// ===== MOBILE FUNCTIONS =====
function toggleDrawer(){
  const sb=document.getElementById('sidebarLeft');
  const ov=document.getElementById('drawerOverlay');
  const btn=document.getElementById('hamburgerBtn');
  if(!sb||!ov||!btn) return;
  const isOpen=sb.classList.contains('open');
  if(isOpen){
    sb.classList.remove('open');
    ov.classList.remove('visible');
    btn.classList.remove('open');
  }else{
    sb.classList.add('open');
    ov.classList.add('visible');
    btn.classList.add('open');
  }
}

function closeDrawer(){
  const sb=document.getElementById('sidebarLeft');
  const ov=document.getElementById('drawerOverlay');
  const btn=document.getElementById('hamburgerBtn');
  if(sb) sb.classList.remove('open');
  if(ov) ov.classList.remove('visible');
  if(btn) btn.classList.remove('open');
}

function openSheet(){
  const s=document.getElementById('statsSheet');
  if(s) s.classList.add('open');
}

function closeSheet(){
  const s=document.getElementById('statsSheet');
  if(s) s.classList.remove('open');
  document.querySelectorAll('.bnav-btn').forEach(b=>b.classList.remove('active'));
  const m=document.getElementById('bnav-map');
  if(m) m.classList.add('active');
}

function switchSheetTab(tab){
  _currentSheetTab=tab;
  document.querySelectorAll('.stab').forEach(b=>b.classList.remove('active'));
  const te=document.getElementById('stab-'+tab);
  if(te) te.classList.add('active');
  const titles={stats:'LIVE STATISTICS',gauges:'WATER LEVEL GAUGES',risk:'FLOOD RISK BY AREA',routes:'EVACUATION ROUTES',alerts:'ALERT FEED'};
  const titleEl=document.getElementById('sheetTitle');
  if(titleEl) titleEl.textContent=titles[tab]||tab.toUpperCase();
  renderSheetBody(tab);
}

function renderSheetBody(tab){
  const body=document.getElementById('sheetBody');
  if(!body) return;
  const mm=parseInt(document.getElementById('rainSlider').value);
  if(tab==='stats'){
    const flooded=zones.filter(z=>z.risk>=4).length;
    const atRisk=zones.filter(z=>z.risk>=2&&z.risk<4).length;
    const totalPop=zones.filter(z=>z.risk>=2).reduce((s,z)=>s+z.pop,0);
    const openR=evakRoutes.filter(r=>r.status==='open').length;
    const ps=totalPop>=1000000?(totalPop/1000000).toFixed(1)+'M':totalPop>1000?(totalPop/1000).toFixed(0)+'K':totalPop;
    body.innerHTML=`<div class="stats-grid"><div class="stat-card red"><div class="stat-value">${flooded}</div><div class="stat-label">Zones Flooded</div></div><div class="stat-card orange"><div class="stat-value">${atRisk}</div><div class="stat-label">At Risk</div></div><div class="stat-card"><div class="stat-value">${ps}</div><div class="stat-label">Pop. Affected</div></div><div class="stat-card green"><div class="stat-value">${openR}</div><div class="stat-label">Routes Open</div></div></div>`;
  }else if(tab==='gauges'){
    body.innerHTML='<div class="gauge-container">'+rivers.map(r=>{
      const lv=Math.min(r.maxLevel,r.baseLevel+(mm/200)*r.maxLevel*0.9);
      const pct=Math.min(100,(lv/r.maxLevel)*100);
      const c=pct>80?'#ff2d55':pct>60?'#ff6b35':pct>40?'#ffd600':'#00e676';
      return `<div class="gauge-row"><span class="gauge-name">${r.name}</span><div class="gauge-bar-wrap"><div class="gauge-bar-fill" style="width:${pct}%;background:${c};"></div></div><span class="gauge-pct" style="color:${c}">${lv.toFixed(1)}m</span></div>`;
    }).join('')+'</div>';
  }else if(tab==='risk'){
    const tz=[...zones].sort((a,b)=>b.risk-a.risk||b.floodRisk-a.floodRisk).slice(0,8);
    body.innerHTML='<div class="bar-chart">'+tz.map(z=>{
      const pct=[0,25,50,75,100][z.risk];
      const color=['#00e676','#4fc3f7','#ffd600','#ff6b35','#ff2d55'][z.risk];
      return `<div class="bar-row"><span class="bar-name">${z.name}</span><div class="bar-track"><div class="bar-fill" style="width:${pct}%;background:${color}"></div></div><span class="bar-pct" style="color:${color}">${pct}%</span></div>`;
    }).join('')+'</div>';
  }else if(tab==='routes'){
    const z=selectedZoneId?zones.find(z=>z.id===selectedZoneId):null;
    const routes=z?getEvakRoutes(selectedZoneId,z.state):evakRoutes;
    const zn=z?z.name:'KL Default';
    body.innerHTML=`<div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);letter-spacing:2px;margin-bottom:8px;">${zn.toUpperCase()}</div><div class="route-card">${routes.map((r,i)=>`<div class="route-item"><div class="route-num">${i+1}</div><div class="route-info"><div class="route-name">${r.name}</div><div class="route-detail">${r.detail}</div></div><span class="route-status route-${r.status}">${r.status.toUpperCase()}</span></div>`).join('')}</div>`;
  }else if(tab==='alerts'){
    body.innerHTML='<div class="alerts-feed">'+alertMessages.map(a=>`<div class="alert-item"><div class="alert-dot" style="background:${dotColors[a.type]||'#00e5ff'}"></div><div class="alert-content"><div class="alert-msg">${a.msg}</div><div class="alert-time">${a.time}</div></div></div>`).join('')+'</div>';
  }
}

function mobileNav(section){
  document.querySelectorAll('.bnav-btn').forEach(b=>b.classList.remove('active'));
  if(section==='map'){
    document.getElementById('bnav-map').classList.add('active');
    closeSheet();
  }else if(section==='rain-ctrl'){
    document.getElementById('bnav-rain').classList.add('active');
    closeSheet();
    toggleDrawer();
  }else if(section==='stats'){
    document.getElementById('bnav-stats').classList.add('active');
    switchSheetTab('stats');openSheet();
  }else if(section==='alerts'){
    document.getElementById('bnav-alerts').classList.add('active');
    switchSheetTab('alerts');openSheet();
  }else if(section==='routes'){
    document.getElementById('bnav-routes').classList.add('active');
    switchSheetTab('routes');openSheet();
  }
}

window.addEventListener('load',init);
</script>
</body>
</html>
